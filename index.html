<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>부스 방문 신청</title>
<style>
body {
    font-family: Arial, sans-serif;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    padding-top: 50px;
    margin: 0;
    background-color: #f0f0f0;
}
.container {
    text-align: center;
    background: #fff;
    padding: 30px;
    border-radius: 8px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    width: 450px;
    margin-bottom: 30px;
}
input, button {
    padding: 12px;
    font-size: 16px;
    margin: 10px 0;
    width: 350px;
    border-radius: 5px;
    border: 1px solid #ccc;
}
.btn {
    background-color: #4CAF50;
    color: white;
    cursor: pointer;
    margin-bottom: 12px;
}
.btn:hover { background-color: #45a049; }
#resetButton {
    background: none;
    color: #333;
    font-size: 36px;
    font-weight: bold;
    border: none;
    cursor: default;
    padding: 0;
    text-decoration: none;
}
#resetButton:hover { color: #4CAF50; }
.button-container { display: flex; justify-content: center; gap: 15px; flex-wrap: wrap; }
.hidden { display: none; }
#remain { text-align: left; margin-top: 10px; }
</style>
</head>
<body>

<div class="container" id="mainScreen">
    <button id="resetButton">부스 방문 신청</button>
    <p>학번을 입력해주세요.</p>
    <input type="text" id="studentId" placeholder="학번을 입력하세요" />
    <div class="button-container">
        <button id="visitButton" class="btn">PC방 예약하기</button>
        <button id="carCodingButton" class="btn">자동차 코딩 예약하기</button>
    </div>
    <p id="message"></p>
    <div id="remain"></div>
</div>

<div class="container hidden" id="reservationScreen">
    <p>예약 시간을 선택하세요.</p>
    <div class="button-container">
        <button class="btn" id="part1">1부</button>
        <button class="btn" id="part2">2부</button>
        <button class="btn" id="part3">3부</button>
        <button class="btn" id="part4">4부</button>
    </div>
</div>

<div class="container hidden" id="confirmationScreen">
    <p>예약 내용 확인</p>
    <p id="confirmationMessage"></p>
    <button class="btn" id="confirmButton">예약 완료</button>
    <button class="btn" id="cancelButton">취소</button>
</div>

<script>
const pcLimit = 10;
const carLimit = 4;
let selectedActivity = '';
let selectedTime = '';
let studentId = '';

// ------------------- 학번 유효성 검사 -------------------
function isValidStudentId(id){
    return /^[1-3]\d{4}$/.test(id);
}

// ------------------- 방문 기록 체크 -------------------
function hasVisited(studentId){
    const visited = JSON.parse(localStorage.getItem('visitedStudents')) || [];
    return visited.includes(studentId);
}

function recordVisit(studentId){
    const visited = JSON.parse(localStorage.getItem('visitedStudents')) || [];
    visited.push(studentId);
    localStorage.setItem('visitedStudents', JSON.stringify(visited));
}

// ------------------- 예약 인원 관리 -------------------
function getCount(key){
    return Number(localStorage.getItem(key)) || 0;
}

function addCount(key){
    let count = getCount(key);
    count++;
    localStorage.setItem(key,count);
}

// ------------------- 잔여인원 표시 -------------------
function updateRemain(){
    let html = '<strong>PC방:</strong> ';
    for(let i=1;i<=4;i++){
        let remain = pcLimit - getCount('pcCount_'+i);
        html += `${i}부:${remain}명 `;
    }
    html += '<br><strong>자동차:</strong> ';
    for(let i=1;i<=4;i++){
        let remain = carLimit - getCount('carCount_'+i);
        html += `${i}부:${remain}명 `;
    }
    document.getElementById('remain').innerHTML = html;
}

// ------------------- 화면 전환 -------------------
function goToReservationScreen(){
    document.getElementById('mainScreen').classList.add('hidden');
    document.getElementById('reservationScreen').classList.remove('hidden');
    updateRemain();
}

function goToConfirmationScreen(){
    document.getElementById('reservationScreen').classList.add('hidden');
    document.getElementById('confirmationScreen').classList.remove('hidden');
    document.getElementById('confirmationMessage').textContent =
        `${studentId}님, ${selectedActivity} 예약\n시간: ${selectedTime}`;
}

// ------------------- 초기화 -------------------
function resetForm(){
    document.getElementById('studentId').value = '';
    document.getElementById('message').textContent = '';
    selectedActivity = '';
    selectedTime = '';
}

// ------------------- Discord Webhook -------------------
function sendDiscordWebhook(message){
    const webhookURL = "https://discord.com/api/webhooks/1453981321507377366/SoPvzvwyHeb9pcGE_jbFuJ_JUwz5tDKZXkj9errKd6YVC1dHHrtCLAx4GwRh4z20bPIv"; // 발급받은 Webhook URL 넣기
    fetch(webhookURL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ content: message })
    })
    .then(response => {
        if(!response.ok) console.error("Discord Webhook 전송 실패");
    })
    .catch(err => console.error(err));
}

// ------------------- 이벤트 -------------------

// 활동 선택 버튼
document.getElementById('visitButton').addEventListener('click',function(){
    studentId = document.getElementById('studentId').value.trim();
    if(!studentId || !isValidStudentId(studentId)){
        document.getElementById('message').textContent="유효하지 않은 학번입니다!";
        document.getElementById('message').style.color='red';
        return;
    }
    if(hasVisited(studentId)){
        document.getElementById('message').textContent="이미 예약한 학생입니다!";
        document.getElementById('message').style.color='red';
        return;
    }
    selectedActivity = 'PC방';
    goToReservationScreen();
});

document.getElementById('carCodingButton').addEventListener('click',function(){
    studentId = document.getElementById('studentId').value.trim();
    if(!studentId || !isValidStudentId(studentId)){
        document.getElementById('message').textContent="유효하지 않은 학번입니다!";
        document.getElementById('message').style.color='red';
        return;
    }
    selectedActivity = '자동차 코딩';
    goToReservationScreen();
});

// 시간 선택
document.querySelectorAll('#reservationScreen .btn').forEach(button=>{
    button.addEventListener('click',function(){
        selectedTime = button.textContent;
        let key = '';
        if(selectedActivity==='PC방') key = 'pcCount_'+selectedTime.charAt(0);
        else key = 'carCount_'+selectedTime.charAt(0);
        let limit = selectedActivity==='PC방'? pcLimit : carLimit;
        if(getCount(key)>=limit){
            alert("이미 마감된 부입니다.");
            return;
        }
        goToConfirmationScreen();
    });
});

// 최종 확인
document.getElementById('confirmButton').addEventListener('click',function(){
    let key = selectedActivity==='PC방'? 'pcCount_'+selectedTime.charAt(0) : 'carCount_'+selectedTime.charAt(0);
    addCount(key);
    if(selectedActivity==='PC방') recordVisit(studentId);

    // Discord 알람
    sendDiscordWebhook(`**${studentId}**님이 **${selectedActivity}**를 ${selectedTime}에 예약했습니다!`);

    alert("예약 완료!");
    document.getElementById('confirmationScreen').classList.add('hidden');
    document.getElementById('mainScreen').classList.remove('hidden');
    resetForm();
    updateRemain();
});

// 취소
document.getElementById('cancelButton').addEventListener('click',function(){
    document.getElementById('confirmationScreen').classList.add('hidden');
    document.getElementById('reservationScreen').classList.remove('hidden');
});

// 초기화 버튼
document.getElementById('resetButton').addEventListener('click',function(){
    let pwd = prompt("비밀번호를 입력하세요:");
    if(pwd==='admin123'){
        localStorage.clear();
        alert("모든 예약 기록 초기화 완료!");
        updateRemain();
    }else alert("비밀번호가 틀렸습니다.");
});

// 초기 로드 시 잔여인원 표시
updateRemain();
</script>

</body>
</html>