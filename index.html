<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ë¶€ìŠ¤ ë°©ë¬¸ ì‹ ì²­</title>
<style>
body {
    font-family: Arial, sans-serif;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    padding-top: 50px;
    margin: 0;
    background-color: #f0f0f0;
}
.container {
    text-align: center;
    background: #fff;
    padding: 30px;
    border-radius: 8px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    width: 450px;
    margin-bottom: 30px;
}
input, button {
    padding: 12px;
    font-size: 16px;
    margin: 10px 0;
    width: 350px;
    border-radius: 5px;
    border: 1px solid #ccc;
}
.btn {
    background-color: #4CAF50;
    color: white;
    cursor: pointer;
    margin-bottom: 12px;
}
.btn:hover { background-color: #45a049; }
#resetButton {
    background: none;
    color: #333;
    font-size: 36px;
    font-weight: bold;
    border: none;
    cursor: default;
    padding: 0;
}
#resetButton:hover { color: #4CAF50; }
.button-container { display: flex; justify-content: center; gap: 15px; flex-wrap: wrap; }
.hidden { display: none; }
#remain { text-align: left; margin-top: 10px; }
</style>
</head>
<body>

<div class="container" id="mainScreen">
    <button id="resetButton">ë¶€ìŠ¤ ë°©ë¬¸ ì‹ ì²­</button>
    <p>í•™ë²ˆì„ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>
    <input type="text" id="studentId" placeholder="í•™ë²ˆì„ ì…ë ¥í•˜ì„¸ìš”" />
    <div class="button-container">
        <button id="visitButton" class="btn">PCë°© ì˜ˆì•½í•˜ê¸°</button>
        <button id="carCodingButton" class="btn">ìë™ì°¨ ì½”ë”© ì˜ˆì•½í•˜ê¸°</button>
    </div>
    <p id="message"></p>
    <div id="remain"></div>
</div>

<div class="container hidden" id="reservationScreen">
    <p>ì˜ˆì•½ ì‹œê°„ì„ ì„ íƒí•˜ì„¸ìš”.</p>
    <div class="button-container">
        <button class="btn">1ë¶€</button>
        <button class="btn">2ë¶€</button>
        <button class="btn">3ë¶€</button>
        <button class="btn">4ë¶€</button>
    </div>
</div>

<div class="container hidden" id="confirmationScreen">
    <p>ì˜ˆì•½ ë‚´ìš© í™•ì¸</p>
    <p id="confirmationMessage"></p>
    <button class="btn" id="confirmButton">ì˜ˆì•½ ì™„ë£Œ</button>
    <button class="btn" id="cancelButton">ì·¨ì†Œ</button>
</div>

<script>
const pcLimit = 10;
const carLimit = 4;
let selectedActivity = '';
let selectedTime = '';
let studentId = '';

// í•™ë²ˆ ê²€ì‚¬
function isValidStudentId(id){
    return /^[1-3]\d{4}$/.test(id);
}

// ë°©ë¬¸ ê¸°ë¡
function hasVisited(studentId){
    const visited = JSON.parse(localStorage.getItem('visitedStudents')) || [];
    return visited.includes(studentId);
}

function recordVisit(studentId){
    const visited = JSON.parse(localStorage.getItem('visitedStudents')) || [];
    visited.push(studentId);
    localStorage.setItem('visitedStudents', JSON.stringify(visited));
}

// ì¸ì› ê´€ë¦¬
function getCount(key){
    return Number(localStorage.getItem(key)) || 0;
}

function addCount(key){
    localStorage.setItem(key, getCount(key) + 1);
}

// ì”ì—¬ ì¸ì› í‘œì‹œ
function updateRemain(){
    let html = '<strong>PCë°©:</strong> ';
    for(let i=1;i<=4;i++){
        html += `${i}ë¶€:${pcLimit - getCount('pcCount_'+i)}ëª… `;
    }
    html += '<br><strong>ìë™ì°¨:</strong> ';
    for(let i=1;i<=4;i++){
        html += `${i}ë¶€:${carLimit - getCount('carCount_'+i)}ëª… `;
    }
    document.getElementById('remain').innerHTML = html;
}

// í™”ë©´ ì „í™˜
function goToReservationScreen(){
    mainScreen.classList.add('hidden');
    reservationScreen.classList.remove('hidden');
    updateRemain();
}

function goToConfirmationScreen(){
    reservationScreen.classList.add('hidden');
    confirmationScreen.classList.remove('hidden');
    confirmationMessage.textContent =
        `${studentId}ë‹˜, ${selectedActivity} ì˜ˆì•½ / ${selectedTime}`;
}

// ğŸ”¥ Netlify Function í˜¸ì¶œ (2ë‹¨ê³„ í•µì‹¬)
function sendDiscordWebhook(message){
    fetch("/.netlify/functions/discord", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message })
    }).catch(err => console.error(err));
}

// ì´ë²¤íŠ¸
visitButton.onclick = () => {
    studentId = studentIdInput.value.trim();
    if(!isValidStudentId(studentId) || hasVisited(studentId)){
        message.textContent = "ìœ íš¨í•˜ì§€ ì•Šê±°ë‚˜ ì´ë¯¸ ì˜ˆì•½ë¨";
        message.style.color = "red";
        return;
    }
    selectedActivity = 'PCë°©';
    goToReservationScreen();
};

carCodingButton.onclick = () => {
    studentId = studentIdInput.value.trim();
    if(!isValidStudentId(studentId) || hasVisited(studentId)){
        message.textContent = "ìœ íš¨í•˜ì§€ ì•Šê±°ë‚˜ ì´ë¯¸ ì˜ˆì•½ë¨";
        message.style.color = "red";
        return;
    }
    selectedActivity = 'ìë™ì°¨ ì½”ë”©';
    goToReservationScreen();
};

document.querySelectorAll('#reservationScreen .btn').forEach(btn=>{
    btn.onclick = () => {
        selectedTime = btn.textContent;
        goToConfirmationScreen();
    };
});

confirmButton.onclick = () => {
    const key = (selectedActivity === 'PCë°©' ? 'pcCount_' : 'carCount_') + selectedTime[0];
    addCount(key);
    recordVisit(studentId);

    sendDiscordWebhook(
        `ğŸ“¢ **${studentId}**ë‹˜ì´ **${selectedActivity}** ${selectedTime} ì˜ˆì•½`
    );

    alert("ì˜ˆì•½ ì™„ë£Œ!");
    location.reload();
};

cancelButton.onclick = () => {
    confirmationScreen.classList.add('hidden');
    reservationScreen.classList.remove('hidden');
};

updateRemain();
</script>

</body>
</html>
